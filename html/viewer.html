<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPAA Image Comparison</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #fff;
            font-family: Arial, Helvetica, sans-serif
        }

        #controls {
            padding: 10px;
            background: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }


        #controls button,
        #controls select {
            padding: 4px 6px;
            cursor: pointer;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdownContent {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            padding: 6px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1;
        }

        .dropdown.open .dropdownContent {
            display: block;
        }

        label {
            display: block;
            white-space: nowrap;
        }

        #container {
            flex: 1;
            display: grid;
            gap: 5px;
            padding: 5px;
        }

        .panel {
            overflow: hidden;
            position: relative;
            border: 2px solid #000;
            border-radius: 8px;
        }

        .panel .label {
            position: absolute;
            top: 3px;
            left: 3px;
            background: rgba(255, 255, 255, 0.95);
            color: black;
            padding: 2px 5px;
            font-size: 28px;
            border-radius: 6px;
            border: 1px solid #777;
        }

        .panel .na {
            text-align: center;
            font-size: 120%;
            color: #888;
        }

        .panel img {
            width: 100%;
            position: absolute;
            transform-origin: top left;
            image-rendering: pixelated;
        }
    </style>
</head>

<body>
    <div id="controls">
        <label for="imageSelect">Choose an image:</label>
        <select id="imageSelect"></select>
        <div class="dropdown" id="algDropdown">
            <button class="dropdownButton">Algorithms ‚åµ</button>
            <div class="dropdownContent" id="algDropdownContent"></div>
        </div>
        <button id="resetZoom">Reset Zoom</button>
        <button id="refreshImages" style="display: none;">Refresh Images</button>
        <button id="swapAlgorithms">Swap last 2 algorithms</button>
    </div>
    <div id="container"></div>

    <script>
        // Constants

        const imageNames = ['lines.png', 'circles.png', 'plot.png', 'sponza.png', 'synthetic.png', 'animated.png'];
        const up_algorithms = ['up_nearest', 'up_tent', 'up_bspline', 'up_mitchell', 'up_catmull'];
        const aa_algorithms = ['ori', 'noaa', 'blur', 'ssaax2', 'ssaax4', 'ssaax8', 'dlaa', 'fxaa2', 'fxaa3c', 'fxaa3d', 'ddaa1', 'ddaa2', 'ddaa2p'];
        const all_algorithms = aa_algorithms.concat(up_algorithms);
        const default_algorithms = ['ori', 'blur', 'ssaax2', 'ssaax4', 'fxaa3c', 'fxaa3d', 'ddaa1', 'ddaa2'];
        const pageIsLocal = window.location.protocol === 'file:'

        // State

        let algorithms = [];
        let imageName = '';
        let nColumns = 0;
        let scale = 1, offsetX = 0, offsetY = 0;
        let isPanning = false, startX, startY;
        let imageRefreshCount = 0;

        // DOM elements

        const container = document.getElementById('container');
        const imgSelect = document.getElementById('imageSelect');
        const algDropdown = document.getElementById("algDropdown");
        const resetButton = document.getElementById('resetZoom');
        const refreshButton = document.getElementById('refreshImages');
        const swapButton = document.getElementById('swapAlgorithms');

        // Tweak / fill DOm elements
        if (pageIsLocal) {
            refreshButton.style.display = 'inline-block';
        }

        imageNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            imgSelect.appendChild(option);
        });

        const algCheckboxes = {};
        all_algorithms.forEach(name => {
            const label = document.createElement("label");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";

            checkbox.addEventListener("change", () => {
                let algs = [...algorithms];
                if (checkbox.checked) {
                    if (!algs.includes(name)) {
                        algs.push(name);
                    }
                } else {
                    algs = algs.filter(item => item !== name);
                }
                setAlgorithms(algs);
            });

            algCheckboxes[name] = checkbox;
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(" " + name));
            document.getElementById("algDropdownContent").appendChild(label);
        });

        // State updaters

        function setAlgorithms(newAlgorithms) {
            if (!arraysEqual(algorithms, newAlgorithms)) {
                algorithms = newAlgorithms;
                updateHash();
                createPanels();
                all_algorithms.forEach(name => {
                    let checkbox = algCheckboxes[name];
                    checkbox.checked = algorithms.includes(name);
                });
            }
        }

        function setImageName(newImageName) {
            if (imageName != newImageName) {
                imageName = newImageName;
                updateHash();
                createPanels();
                resetTransforms();
                imgSelect.value = imageName;
            }
        }

        function setNColumns(newNColumns) {
            if (nColumns != newNColumns) {
                nColumns = newNColumns;
                updateHash();
                createPanels();
            }
        }

        // Handlers

        refreshButton.addEventListener('click', refreshImages);
        swapButton.addEventListener('click', () => { let n = algorithms.length; setAlgorithms([...algorithms.slice(0, n - 2), algorithms[n - 1], algorithms[n - 2]]); });
        resetButton.addEventListener('click', resetTransforms);
        imgSelect.addEventListener('change', () => setImageName(imgSelect.value));

        // Toggle dropdown
        algDropdown.querySelector(".dropdownButton").onclick = () => {
            algDropdown.classList.toggle("open");
        };

        // Close dropdown when clicking outside
        document.addEventListener("click", e => {
            if (!algDropdown.contains(e.target)) {
                algDropdown.classList.remove("open");
            }
        });

        window.addEventListener('hashchange', handleHashChange);
        window.addEventListener('load', handleHashChange);

        // Functions

        function updateHash() {
            let hash = "image=" + imageName + "&algs=" + algorithms.join(",");
            if (nColumns > 0) {
                hash += "&ncols=" + nColumns;
            }
            window.location.hash = hash;
        }

        function handleHashChange() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            let img = params.get("image") ?? "";
            let algs = params.get("algs")?.split(',') ?? [];
            let ncols = Math.floor(Number(params.get("ncols")) || 0);
            algs = algs.filter(str => str !== "");

            if (img.length == 0) {
                img = imageNames[0];
            }
            if (algs.length == 0) {
                algs = default_algorithms;
            }

            setImageName(img);
            setAlgorithms(algs);
            setNColumns(ncols);
        }

        function arraysEqual(a, b) {
            return a.length === b.length && a.every((val, i) => val === b[i]);
        }

        function createPanels() {
            container.innerHTML = '';
            const panelCount = algorithms.length;
            const ratio = document.body.clientWidth / document.body.clientHeight;
            const ncolsAauto = Math.min(panelCount, Math.floor(ratio * Math.sqrt(panelCount)));
            let ncols = nColumns;
            if (ncols <= 0) { ncols = ncolsAauto; }
            if (ncols <= 0) { ncols = 1; }
            let nrows = Math.ceil(panelCount / ncols);
            container.style.gridTemplateColumns = `repeat(${ncols}, 1fr)`;
            container.style.gridTemplateRows = `repeat(${nrows}, 1fr)`;

            algorithms.forEach(algo => {
                if (algo == 'ori') { algo = ''; }
                let suffix = algo ? '_' + algo : '';
                let src = `images_all/${imageName.split('.')[0]}${suffix}.png`
                if (pageIsLocal) { src = '../' + src; }
                let label = algo || 'original';

                const panel = document.createElement('div');
                panel.className = 'panel';

                let img = document.createElement('img');
                img.src = src + '?' + imageRefreshCount;
                img.draggable = false;

                if (imageName == 'synthetic.png' && algo.startsWith('ssaa')) {
                    img = document.createElement("div");
                    img.innerHTML = "<br>Image not available for SSAA";
                    img.className = 'na';
                }

                const lbl = document.createElement('div');
                lbl.className = 'label';
                lbl.textContent = label;

                panel.appendChild(img);
                panel.appendChild(lbl);
                container.appendChild(panel);
            });
            updateTransforms();
            window.setTimeout(updateTransforms, 100);
        }

        function resetTransforms() {
            offsetX = 0;
            offsetY = 0;
            scale = 1;
            updateTransforms();
        }

        function updateTransforms() {
            document.querySelectorAll('.panel img').forEach(img => {
                img.style.left = `${offsetX}px`;
                img.style.top = `${offsetY}px`;
                if (img.naturalWidth) {
                    img.style.width = `${scale * img.naturalWidth}px`;
                } else {
                    img.style.width = '';  // default
                }
            });
        }

        function refreshImages() {
            imageRefreshCount += 1;
            document.querySelectorAll('.panel img').forEach(img => {
                img.src = img.src.split('?')[0] + '?' + imageRefreshCount;
            });
        }

        container.addEventListener('wheel', event => {
            event.preventDefault();
            let scaleFactor = Math.pow(2, -0.003 * event.deltaY);

            // Get panel center
            let img_el = document.querySelectorAll('.panel img')[0];
            let panelRect = img_el.parentElement.getBoundingClientRect();
            let panelCenterX = panelRect.width / 2;
            let panelCenterY = panelRect.height / 2;

            // Convert panel center to image coordinates
            let imgOffsetX = panelCenterX - offsetX;
            let imgOffsetY = panelCenterY - offsetY;
            let centerImgX = imgOffsetX / scale;
            let centerImgY = imgOffsetY / scale;

            // Apply new scale and offsets
            scale = scale * scaleFactor;
            offsetX = panelCenterX - centerImgX * scale;
            offsetY = panelCenterY - centerImgY * scale;

            updateTransforms();
        });

        container.addEventListener('mousedown', event => {
            if (event.button !== 0) return;
            isPanning = true;
            startX = event.clientX - offsetX;
            startY = event.clientY - offsetY;
        });

        window.addEventListener('mousemove', event => {
            if (!isPanning) return;
            offsetX = (event.clientX - startX);
            offsetY = (event.clientY - startY);
            updateTransforms();
        });

        window.addEventListener('mouseup', () => isPanning = false);

        console.log("For screenshots, set the viewport 1200px wide, dpr 2.");
        console.log("Use window.hideControls() to hide the control bar. Use showControls() to put back.");
        window.hideControls = function () {
            let el = document.getElementById('controls');
            el.style.display = 'none';
        }
        window.showControls = function () {
            let el = document.getElementById('controls');
            el.style.display = '';
        }

    </script>
</body>

</html>